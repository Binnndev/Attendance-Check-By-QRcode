openapi: 3.0.3
info:
  title: Attendance QR API (DB v1.0 exact)
  version: 1.0.0
servers:
  - url: /api/v1
security:
  - bearerAuth: []
tags:
  - name: Auth
  - name: Me
  - name: Groups
  - name: Members
  - name: Sessions
  - name: QR
  - name: Attendance
  - name: Absence
  - name: Events

paths:
  /auth/login:
    post:
      tags: [Auth]
      security: []
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TokenResponse" }
        "401": { $ref: "#/components/responses/Err401" }

  /me:
    get:
      tags: [Me]
      summary: Get my profile
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/MeResponse" }
        "401": { $ref: "#/components/responses/Err401" }

    patch:
      tags: [Me]
      summary: Update my profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateMeRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/MeResponse" }
        "400": { $ref: "#/components/responses/Err400" }
        "401": { $ref: "#/components/responses/Err401" }

  /groups:
    post:
      tags: [Groups]
      summary: Create group (caller becomes OWNER)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateGroupRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GroupResponse" }
        "409": { $ref: "#/components/responses/Err409" }
        "400": { $ref: "#/components/responses/Err400" }

    get:
      tags: [Groups]
      summary: List my groups
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageGroupResponse" }

  /groups/{groupId}:
    get:
      tags: [Groups]
      summary: Get group details
      parameters:
        - $ref: "#/components/parameters/GroupId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GroupResponse" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }

    patch:
      tags: [Groups]
      summary: Update group (OWNER/ADMIN)
      parameters:
        - $ref: "#/components/parameters/GroupId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateGroupRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GroupResponse" }
        "400": { $ref: "#/components/responses/Err400" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }
        "409": { $ref: "#/components/responses/Err409" }

  /groups/{groupId}/archive:
    post:
      tags: [Groups]
      summary: Archive group (OWNER/ADMIN)
      parameters:
        - $ref: "#/components/parameters/GroupId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GroupResponse" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }

  /groups/join:
    post:
      tags: [Members]
      summary: Join group by joinCode
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/JoinGroupRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/MemberResponse" }
        "404": { $ref: "#/components/responses/Err404" }
        "400": { $ref: "#/components/responses/Err400" }

  /groups/{groupId}/members:
    get:
      tags: [Members]
      summary: List members (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/GroupId"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageMemberResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/members/{userId}:
    patch:
      tags: [Members]
      summary: Member action (approve/reject/remove/promote/demote/transfer ownership)
      parameters:
        - $ref: "#/components/parameters/GroupId"
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/MemberActionRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/MemberResponse" }
        "422": { $ref: "#/components/responses/Err422" }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/members/me:
    delete:
      tags: [Members]
      summary: Leave group (MEMBER/CO_HOST). OWNER cannot leave.
      parameters:
        - $ref: "#/components/parameters/GroupId"
      responses:
        "204": { description: No Content }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/sessions:
    post:
      tags: [Sessions]
      summary: Create session (OWNER/CO_HOST/ADMIN)
      description: >
        DB enforces one OPEN session per group via UNIQUE KEY uk_as_group_single_open (group_id, is_open).
        V4 adds checkin_open_at/checkin_close_at and CHECK chk_as_checkin_window.
      parameters:
        - $ref: "#/components/parameters/GroupId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateSessionRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

    get:
      tags: [Sessions]
      summary: List sessions by group
      parameters:
        - $ref: "#/components/parameters/GroupId"
        - name: from
          in: query
          schema: { type: string, format: date }
        - name: to
          in: query
          schema: { type: string, format: date }
        - name: status
          in: query
          schema: { $ref: "#/components/schemas/SessionStatus" }
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageSessionResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/sessions/open:
    get:
      tags: [Sessions]
      summary: Get OPEN session of group (if any)
      parameters:
        - $ref: "#/components/parameters/GroupId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        "404": { $ref: "#/components/responses/Err404" }

  /sessions/{sessionId}:
    get:
      tags: [Sessions]
      summary: Get session
      parameters:
        - $ref: "#/components/parameters/SessionId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }

  /sessions/{sessionId}/close:
    post:
      tags: [Sessions]
      summary: Close session (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CloseSessionRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

  /sessions/{sessionId}/cancel:
    post:
      tags: [Sessions]
      summary: Cancel session (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/SessionId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /sessions/{sessionId}/qr/rotate:
    post:
      tags: [QR]
      summary: Rotate QR token (OWNER/CO_HOST/ADMIN)
      description: >
        qr_tokens.token_id VARCHAR(64) ascii_bin PK.
        token_hash VARBINARY(32) UNIQUE uk_qt_token_hash.
        chk_qt_exp_after_issued: expires_at > issued_at.
      parameters:
        - $ref: "#/components/parameters/SessionId"
      responses:
        "200":
          description: OK (plaintext token returned once)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RotateQrResponse" }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

  /sessions/{sessionId}/checkin/qr:
    post:
      tags: [Attendance]
      summary: QR check-in (RULE CHỐT)
      description: >
        RULE CHỐT:
        - Reject if now < checkin_open_at  => CHECKIN_NOT_OPEN_YET
        - Reject if now > checkin_close_at => CHECKIN_CLOSED
        - lateThreshold = checkin_open_at + late_after_minutes
          now <= lateThreshold => PRESENT
          lateThreshold < now <= checkin_close_at => LATE
        DB v6 enforces token belongs to session via FK fk_sa_session_qr_token (session_id, qr_token_id)
          -> qr_tokens(session_id, token_id)
      parameters:
        - $ref: "#/components/parameters/SessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/QrCheckinRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AttendanceRecordResponse" }
        "400": { $ref: "#/components/responses/Err400" }
        "403": { $ref: "#/components/responses/Err403" }
        "409": { $ref: "#/components/responses/Err409" }

  /sessions/{sessionId}/attendance:
    get:
      tags: [Attendance]
      summary: List attendance of session (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/SessionId"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageAttendanceResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /sessions/{sessionId}/attendance/{userId}:
    post:
      tags: [Attendance]
      summary: Manual mark attendance (OWNER/CO_HOST/ADMIN, allow_manual_override must be 1)
      parameters:
        - $ref: "#/components/parameters/SessionId"
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ManualMarkAttendanceRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AttendanceRecordResponse" }
        "409": { $ref: "#/components/responses/Err409" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/absence-requests:
    post:
      tags: [Absence]
      summary: Create absence request (XOR enforced by triggers)
      parameters:
        - $ref: "#/components/parameters/GroupId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateAbsenceRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AbsenceResponse" }
        "422": { $ref: "#/components/responses/Err422" }
        "403": { $ref: "#/components/responses/Err403" }

    get:
      tags: [Absence]
      summary: List absence requests (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/GroupId"
        - name: status
          in: query
          schema: { $ref: "#/components/schemas/AbsenceRequestStatus" }
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageAbsenceResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /absence-requests/{requestId}:
    get:
      tags: [Absence]
      summary: Get absence request
      parameters:
        - name: requestId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AbsenceResponse" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }

  /absence-requests/{requestId}/review:
    patch:
      tags: [Absence]
      summary: Review absence request (OWNER/CO_HOST/ADMIN)
      parameters:
        - name: requestId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ReviewAbsenceRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AbsenceResponse" }
        "422": { $ref: "#/components/responses/Err422" }
        "403": { $ref: "#/components/responses/Err403" }

  /absence-requests/{requestId}/cancel:
    post:
      tags: [Absence]
      summary: Cancel absence request (requester or ADMIN)
      parameters:
        - name: requestId
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AbsenceResponse" }
        "403": { $ref: "#/components/responses/Err403" }
        "404": { $ref: "#/components/responses/Err404" }

  /sessions/{sessionId}/events:
    get:
      tags: [Events]
      summary: List session events (OWNER/CO_HOST/ADMIN). attendance_events immutable by trigger.
      parameters:
        - $ref: "#/components/parameters/SessionId"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
        - name: type
          in: query
          schema: { $ref: "#/components/schemas/EventType" }
        - name: from
          in: query
          schema: { type: string, format: date-time }
        - name: to
          in: query
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageEventResponse" }
        "403": { $ref: "#/components/responses/Err403" }

  /groups/{groupId}/events:
    get:
      tags: [Events]
      summary: List group events (OWNER/CO_HOST/ADMIN)
      parameters:
        - $ref: "#/components/parameters/GroupId"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/Size"
        - name: type
          in: query
          schema: { $ref: "#/components/schemas/EventType" }
        - name: from
          in: query
          schema: { type: string, format: date-time }
        - name: to
          in: query
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PageEventResponse" }
        "403": { $ref: "#/components/responses/Err403" }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    GroupId:
      name: groupId
      in: path
      required: true
      schema: { type: string, format: uuid }
    SessionId:
      name: sessionId
      in: path
      required: true
      schema: { type: string, format: uuid }
    UserId:
      name: userId
      in: path
      required: true
      schema: { type: string, format: uuid }
    Page:
      name: page
      in: query
      schema: { type: integer, minimum: 0, default: 0 }
    Size:
      name: size
      in: query
      schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
    Sort:
      name: sort
      in: query
      schema: { type: string, example: "createdAt,desc" }

  responses:
    Err400:
      description: Bad Request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            validation:
              value: { status: 400, code: VALIDATION_ERROR, message: "Invalid request" }
    Err401:
      description: Unauthorized
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            unauthorized:
              value: { status: 401, code: UNAUTHORIZED, message: "Missing or invalid token" }
    Err403:
      description: Forbidden
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            forbidden:
              value: { status: 403, code: FORBIDDEN, message: "Not allowed" }
    Err404:
      description: Not Found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            notFound:
              value: { status: 404, code: NOT_FOUND, message: "Resource not found" }
    Err409:
      description: Conflict
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            conflict:
              value: { status: 409, code: CONFLICT, message: "Conflict" }
    Err422:
      description: Unprocessable Entity
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            rule:
              value: { status: 422, code: BUSINESS_RULE_VIOLATION, message: "Rule violation" }

  schemas:
    ApiError:
      type: object
      properties:
        timestamp: { type: string, format: date-time }
        status: { type: integer }
        code: { type: string }
        message: { type: string }
        path: { type: string }
        traceId: { type: string }
      required: [timestamp, status, code, message, path]

    # --- ENUMS (exact) ---
    PlatformRole: { type: string, enum: [ADMIN, USER] }
    UserStatus: { type: string, enum: [ACTIVE, INACTIVE, BANNED] }
    ApprovalMode: { type: string, enum: [AUTO, MANUAL] }
    GroupStatus: { type: string, enum: [ACTIVE, ARCHIVED] }
    MemberRole: { type: string, enum: [OWNER, CO_HOST, MEMBER] }
    MemberStatus: { type: string, enum: [PENDING, APPROVED, REJECTED, REMOVED] }
    SessionStatus: { type: string, enum: [OPEN, CLOSED, CANCELLED] }
    AttendanceStatus: { type: string, enum: [ABSENT, PRESENT, LATE, EXCUSED] }
    CheckInMethod: { type: string, enum: [QR, MANUAL] }
    AbsenceRequestStatus: { type: string, enum: [PENDING, APPROVED, REJECTED, CANCELLED] }
    EventType:
      type: string
      enum:
        [CHECKIN_QR, MARK_MANUAL_PRESENT, MARK_MANUAL_LATE, MARK_MANUAL_ABSENT,
         MARK_EXCUSED, REVERT_FROM_EXCUSED, SESSION_OPENED, SESSION_CLOSED]

    # --- AUTH/ME (users table exact lengths) ---
    LoginRequest:
      type: object
      properties:
        email: { type: string, format: email, maxLength: 190 }
        password: { type: string, minLength: 6, maxLength: 200 }
      required: [email, password]

    TokenResponse:
      type: object
      properties:
        accessToken: { type: string }
        refreshToken: { type: string }
        expiresInSeconds: { type: integer }
      required: [accessToken, expiresInSeconds]

    MeResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email, maxLength: 190 }
        fullName: { type: string, maxLength: 120 }
        avatarUrl: { type: string, maxLength: 500 }
        userCode: { type: string, maxLength: 40 }
        primaryDeviceId: { type: string, maxLength: 120 }
        platformRole: { $ref: "#/components/schemas/PlatformRole" }
        status: { $ref: "#/components/schemas/UserStatus" }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, email, fullName, platformRole, status, createdAt, updatedAt]

    UpdateMeRequest:
      type: object
      properties:
        fullName: { type: string, minLength: 2, maxLength: 120 }
        avatarUrl: { type: string, maxLength: 500 }
        primaryDeviceId: { type: string, maxLength: 120 }

    # --- GROUPS (class_groups exact) ---
    CreateGroupRequest:
      type: object
      properties:
        name: { type: string, minLength: 3, maxLength: 150 }   # chk_groups_name_len
        code: { type: string, maxLength: 20 }                   # uk_groups_code
        joinCode: { type: string, minLength: 6, maxLength: 16 } # chk_groups_join_code_len + uk_groups_join_code
        description: { type: string, maxLength: 1000 }
        semester: { type: string, maxLength: 30 }
        room: { type: string, maxLength: 80 }
        approvalMode: { $ref: "#/components/schemas/ApprovalMode" }
        allowAutoJoinOnCheckin: { type: boolean, default: false }
      required: [name, code, approvalMode]

    UpdateGroupRequest:
      type: object
      properties:
        name: { type: string, minLength: 3, maxLength: 150 }
        joinCode: { type: string, minLength: 6, maxLength: 16 }
        description: { type: string, maxLength: 1000 }
        semester: { type: string, maxLength: 30 }
        room: { type: string, maxLength: 80 }
        approvalMode: { $ref: "#/components/schemas/ApprovalMode" }
        allowAutoJoinOnCheckin: { type: boolean }
        status: { $ref: "#/components/schemas/GroupStatus" }

    GroupResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        ownerUserId: { type: string, format: uuid }
        name: { type: string, maxLength: 150 }
        code: { type: string, maxLength: 20 }
        joinCode: { type: string, maxLength: 16 }
        description: { type: string, maxLength: 1000 }
        semester: { type: string, maxLength: 30 }
        room: { type: string, maxLength: 80 }
        approvalMode: { $ref: "#/components/schemas/ApprovalMode" }
        allowAutoJoinOnCheckin: { type: boolean }
        status: { $ref: "#/components/schemas/GroupStatus" }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, ownerUserId, name, code, joinCode, approvalMode, status, createdAt, updatedAt]

    # --- MEMBERS (group_members exact) ---
    JoinGroupRequest:
      type: object
      properties:
        joinCode: { type: string, minLength: 6, maxLength: 16 }
      required: [joinCode]

    MemberActionRequest:
      type: object
      properties:
        action:
          type: string
          enum: [APPROVE, REJECT, REMOVE, PROMOTE, DEMOTE, TRANSFER_OWNERSHIP]
        targetRole:
          type: string
          enum: [OWNER, CO_HOST, MEMBER]
        note: { type: string, maxLength: 500 }
      required: [action]

    MemberResponse:
      type: object
      properties:
        groupId: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        role: { $ref: "#/components/schemas/MemberRole" }
        memberStatus: { $ref: "#/components/schemas/MemberStatus" }
        joinedAt: { type: string, format: date-time }
        invitedBy: { type: string, format: uuid }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        removedAt: { type: string, format: date-time }
      required: [groupId, userId, role, memberStatus, createdAt, updatedAt]

    # --- SESSIONS (attendance_sessions exact) ---
    CreateSessionRequest:
      type: object
      properties:
        title: { type: string, maxLength: 150 }
        startAt: { type: string, format: date-time }
        endAt: { type: string, format: date-time }
        timeWindowMinutes: { type: integer, minimum: 1, maximum: 300, default: 15 }   # chk_as_window
        lateAfterMinutes: { type: integer, minimum: 1, maximum: 120, default: 5 }     # chk_as_late + chk_as_late_le_window
        qrRotateSeconds: { type: integer, minimum: 5, maximum: 120, default: 15 }     # chk_as_rotate
        checkinOpenAt: { type: string, format: date-time }                            # V4
        checkinCloseAt: { type: string, format: date-time }                           # V4 + chk_as_checkin_window
        allowManualOverride: { type: boolean, default: true }                         # TINYINT default 1
        note: { type: string, maxLength: 500 }
      required: [startAt]

    CloseSessionRequest:
      type: object
      properties:
        note: { type: string, maxLength: 500 }

    SessionResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        groupId: { type: string, format: uuid }
        createdByUserId: { type: string, format: uuid }
        title: { type: string, maxLength: 150 }
        sessionDate: { type: string, format: date }
        status: { $ref: "#/components/schemas/SessionStatus" }
        startAt: { type: string, format: date-time }
        checkinOpenAt: { type: string, format: date-time }
        checkinCloseAt: { type: string, format: date-time }
        endAt: { type: string, format: date-time }
        timeWindowMinutes: { type: integer }
        lateAfterMinutes: { type: integer }
        qrRotateSeconds: { type: integer }
        allowManualOverride: { type: boolean }
        note: { type: string, maxLength: 500 }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, groupId, createdByUserId, sessionDate, status, startAt, createdAt, updatedAt]

    # --- QR TOKENS (qr_tokens exact) ---
    RotateQrResponse:
      type: object
      properties:
        sessionId: { type: string, format: uuid }
        token: { type: string }
        issuedAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
      required: [sessionId, token, issuedAt, expiresAt]

    # --- ATTENDANCE (session_attendance exact) ---
    QrCheckinRequest:
      type: object
      properties:
        token: { type: string }
        deviceId: { type: string, maxLength: 120 }
        ipAddress: { type: string, maxLength: 45 }
        userAgent: { type: string, maxLength: 255 }
        geoLat: { type: number, format: double }
        geoLng: { type: number, format: double }
        distanceMeter: { type: integer, minimum: 0 }
      required: [token]

    ManualMarkAttendanceRequest:
      type: object
      properties:
        status: { $ref: "#/components/schemas/AttendanceStatus" }
        note: { type: string, maxLength: 500 }
      required: [status]

    AttendanceRecordResponse:
      type: object
      properties:
        sessionId: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        attendanceStatus: { $ref: "#/components/schemas/AttendanceStatus" }
        checkInAt: { type: string, format: date-time }
        checkInMethod: { $ref: "#/components/schemas/CheckInMethod" }
        qrTokenId: { type: string, maxLength: 64 }
        deviceId: { type: string, maxLength: 120 }
        ipAddress: { type: string, maxLength: 45 }
        userAgent: { type: string, maxLength: 255 }
        geoLat: { type: number, format: double }
        geoLng: { type: number, format: double }
        distanceMeter: { type: integer, minimum: 0 }
        suspiciousFlag: { type: boolean }
        suspiciousReason: { type: string, maxLength: 500 }
        excusedByRequestId: { type: string, format: uuid }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [sessionId, userId, attendanceStatus, createdAt, updatedAt]

    # --- ABSENCE (absence_requests exact) ---
    CreateAbsenceRequest:
      type: object
      properties:
        linkedSessionId: { type: string, format: uuid }
        requestedDate: { type: string, format: date }
        reason: { type: string, minLength: 3, maxLength: 500 }    # chk_ar_reason_len
        evidenceUrl: { type: string, maxLength: 500 }
      required: [reason]
      description: "XOR enforced by triggers: exactly one of linkedSessionId or requestedDate."

    ReviewAbsenceRequest:
      type: object
      properties:
        action: { type: string, enum: [APPROVE, REJECT] }
        reviewerNote: { type: string, maxLength: 500 }
      required: [action]

    AbsenceResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        groupId: { type: string, format: uuid }
        requesterUserId: { type: string, format: uuid }
        linkedSessionId: { type: string, format: uuid }
        requestedDate: { type: string, format: date }
        reason: { type: string, maxLength: 500 }
        evidenceUrl: { type: string, maxLength: 500 }
        requestStatus: { $ref: "#/components/schemas/AbsenceRequestStatus" }
        reviewerUserId: { type: string, format: uuid }
        reviewerNote: { type: string, maxLength: 500 }
        reviewedAt: { type: string, format: date-time }
        cancelledAt: { type: string, format: date-time }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, groupId, requesterUserId, reason, requestStatus, createdAt, updatedAt]

    # --- EVENTS (attendance_events exact + qr_token_id from V5) ---
    EventResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        sessionId: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        actorUserId: { type: string, format: uuid }
        eventType: { $ref: "#/components/schemas/EventType" }
        oldStatus: { $ref: "#/components/schemas/AttendanceStatus" }
        newStatus: { $ref: "#/components/schemas/AttendanceStatus" }
        qrTokenId: { type: string, maxLength: 64 }
        eventPayload: { type: object, additionalProperties: true }
        createdAt: { type: string, format: date-time }
      required: [id, sessionId, userId, eventType, createdAt]

    PageGroupResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/GroupResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]

    PageMemberResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/MemberResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]

    PageSessionResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/SessionResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]

    PageAttendanceResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/AttendanceRecordResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]

    PageAbsenceResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/AbsenceResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]

    PageEventResponse:
      type: object
      properties:
        items: { type: array, items: { $ref: "#/components/schemas/EventResponse" } }
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer }
        totalPages: { type: integer }
      required: [items, page, size, totalElements, totalPages]
